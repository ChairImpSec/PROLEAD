#include <stdlib.h>
#include <string.h>
#include <stdint.h>


#define PRGA 0
#define PRGB 1
#define PRGC 2

uint8_t share1[16] __attribute__((section(".data")));
uint8_t share2[16] __attribute__((section(".data")));

uint8_t tsmult[1024]={
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x01,0x02,0x03,0x04,0x05,0x06,0x07,
0x08,0x09,0x0a,0x0b,0x0c,0x0d,0x0e,0x0f,
0x00,0x02,0x04,0x06,0x08,0x0a,0x0c,0x0e,
0x10,0x12,0x14,0x16,0x18,0x1a,0x1c,0x1e,
0x00,0x03,0x06,0x05,0x0c,0x0f,0x0a,0x09,
0x18,0x1b,0x1e,0x1d,0x14,0x17,0x12,0x11,
0x00,0x04,0x08,0x0c,0x10,0x14,0x18,0x1c,
0x20,0x24,0x28,0x2c,0x30,0x34,0x38,0x3c,
0x00,0x05,0x0a,0x0f,0x14,0x11,0x1e,0x1b,
0x28,0x2d,0x22,0x27,0x3c,0x39,0x36,0x33,
0x00,0x06,0x0c,0x0a,0x18,0x1e,0x14,0x12,
0x30,0x36,0x3c,0x3a,0x28,0x2e,0x24,0x22,
0x00,0x07,0x0e,0x09,0x1c,0x1b,0x12,0x15,
0x38,0x3f,0x36,0x31,0x24,0x23,0x2a,0x2d,
0x00,0x08,0x10,0x18,0x20,0x28,0x30,0x38,
0x40,0x48,0x50,0x58,0x60,0x68,0x70,0x78,
0x00,0x09,0x12,0x1b,0x24,0x2d,0x36,0x3f,
0x48,0x41,0x5a,0x53,0x6c,0x65,0x7e,0x77,
0x00,0x0a,0x14,0x1e,0x28,0x22,0x3c,0x36,
0x50,0x5a,0x44,0x4e,0x78,0x72,0x6c,0x66,
0x00,0x0b,0x16,0x1d,0x2c,0x27,0x3a,0x31,
0x58,0x53,0x4e,0x45,0x74,0x7f,0x62,0x69,
0x00,0x0c,0x18,0x14,0x30,0x3c,0x28,0x24,
0x60,0x6c,0x78,0x74,0x50,0x5c,0x48,0x44,
0x00,0x0d,0x1a,0x17,0x34,0x39,0x2e,0x23,
0x68,0x65,0x72,0x7f,0x5c,0x51,0x46,0x4b,
0x00,0x0e,0x1c,0x12,0x38,0x36,0x24,0x2a,
0x70,0x7e,0x6c,0x62,0x48,0x46,0x54,0x5a,
0x00,0x0f,0x1e,0x11,0x3c,0x33,0x22,0x2d,
0x78,0x77,0x66,0x69,0x44,0x4b,0x5a,0x55,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x10,0x20,0x30,0x40,0x50,0x60,0x70,
0x80,0x90,0xa0,0xb0,0xc0,0xd0,0xe0,0xf0,
0x00,0x20,0x40,0x60,0x80,0xa0,0xc0,0xe0,
0x1b,0x3b,0x5b,0x7b,0x9b,0xbb,0xdb,0xfb,
0x00,0x30,0x60,0x50,0xc0,0xf0,0xa0,0x90,
0x9b,0xab,0xfb,0xcb,0x5b,0x6b,0x3b,0x0b,
0x00,0x40,0x80,0xc0,0x1b,0x5b,0x9b,0xdb,
0x36,0x76,0xb6,0xf6,0x2d,0x6d,0xad,0xed,
0x00,0x50,0xa0,0xf0,0x5b,0x0b,0xfb,0xab,
0xb6,0xe6,0x16,0x46,0xed,0xbd,0x4d,0x1d,
0x00,0x60,0xc0,0xa0,0x9b,0xfb,0x5b,0x3b,
0x2d,0x4d,0xed,0x8d,0xb6,0xd6,0x76,0x16,
0x00,0x70,0xe0,0x90,0xdb,0xab,0x3b,0x4b,
0xad,0xdd,0x4d,0x3d,0x76,0x06,0x96,0xe6,
0x00,0x80,0x1b,0x9b,0x36,0xb6,0x2d,0xad,
0x6c,0xec,0x77,0xf7,0x5a,0xda,0x41,0xc1,
0x00,0x90,0x3b,0xab,0x76,0xe6,0x4d,0xdd,
0xec,0x7c,0xd7,0x47,0x9a,0x0a,0xa1,0x31,
0x00,0xa0,0x5b,0xfb,0xb6,0x16,0xed,0x4d,
0x77,0xd7,0x2c,0x8c,0xc1,0x61,0x9a,0x3a,
0x00,0xb0,0x7b,0xcb,0xf6,0x46,0x8d,0x3d,
0xf7,0x47,0x8c,0x3c,0x01,0xb1,0x7a,0xca,
0x00,0xc0,0x9b,0x5b,0x2d,0xed,0xb6,0x76,
0x5a,0x9a,0xc1,0x01,0x77,0xb7,0xec,0x2c,
0x00,0xd0,0xbb,0x6b,0x6d,0xbd,0xd6,0x06,
0xda,0x0a,0x61,0xb1,0xb7,0x67,0x0c,0xdc,
0x00,0xe0,0xdb,0x3b,0xad,0x4d,0x76,0x96,
0x41,0xa1,0x9a,0x7a,0xec,0x0c,0x37,0xd7,
0x00,0xf0,0xfb,0x0b,0xed,0x1d,0x16,0xe6,
0xc1,0x31,0x3a,0xca,0x2c,0xdc,0xd7,0x27,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x10,0x20,0x30,0x40,0x50,0x60,0x70,
0x80,0x90,0xa0,0xb0,0xc0,0xd0,0xe0,0xf0,
0x00,0x20,0x40,0x60,0x80,0xa0,0xc0,0xe0,
0x1b,0x3b,0x5b,0x7b,0x9b,0xbb,0xdb,0xfb,
0x00,0x30,0x60,0x50,0xc0,0xf0,0xa0,0x90,
0x9b,0xab,0xfb,0xcb,0x5b,0x6b,0x3b,0x0b,
0x00,0x40,0x80,0xc0,0x1b,0x5b,0x9b,0xdb,
0x36,0x76,0xb6,0xf6,0x2d,0x6d,0xad,0xed,
0x00,0x50,0xa0,0xf0,0x5b,0x0b,0xfb,0xab,
0xb6,0xe6,0x16,0x46,0xed,0xbd,0x4d,0x1d,
0x00,0x60,0xc0,0xa0,0x9b,0xfb,0x5b,0x3b,
0x2d,0x4d,0xed,0x8d,0xb6,0xd6,0x76,0x16,
0x00,0x70,0xe0,0x90,0xdb,0xab,0x3b,0x4b,
0xad,0xdd,0x4d,0x3d,0x76,0x06,0x96,0xe6,
0x00,0x80,0x1b,0x9b,0x36,0xb6,0x2d,0xad,
0x6c,0xec,0x77,0xf7,0x5a,0xda,0x41,0xc1,
0x00,0x90,0x3b,0xab,0x76,0xe6,0x4d,0xdd,
0xec,0x7c,0xd7,0x47,0x9a,0x0a,0xa1,0x31,
0x00,0xa0,0x5b,0xfb,0xb6,0x16,0xed,0x4d,
0x77,0xd7,0x2c,0x8c,0xc1,0x61,0x9a,0x3a,
0x00,0xb0,0x7b,0xcb,0xf6,0x46,0x8d,0x3d,
0xf7,0x47,0x8c,0x3c,0x01,0xb1,0x7a,0xca,
0x00,0xc0,0x9b,0x5b,0x2d,0xed,0xb6,0x76,
0x5a,0x9a,0xc1,0x01,0x77,0xb7,0xec,0x2c,
0x00,0xd0,0xbb,0x6b,0x6d,0xbd,0xd6,0x06,
0xda,0x0a,0x61,0xb1,0xb7,0x67,0x0c,0xdc,
0x00,0xe0,0xdb,0x3b,0xad,0x4d,0x76,0x96,
0x41,0xa1,0x9a,0x7a,0xec,0x0c,0x37,0xd7,
0x00,0xf0,0xfb,0x0b,0xed,0x1d,0x16,0xe6,
0xc1,0x31,0x3a,0xca,0x2c,0xdc,0xd7,0x27,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x1b,0x36,0x2d,0x6c,0x77,0x5a,0x41,
0xd8,0xc3,0xee,0xf5,0xb4,0xaf,0x82,0x99,
0x00,0x36,0x6c,0x5a,0xd8,0xee,0xb4,0x82,
0xab,0x9d,0xc7,0xf1,0x73,0x45,0x1f,0x29,
0x00,0x2d,0x5a,0x77,0xb4,0x99,0xee,0xc3,
0x73,0x5e,0x29,0x04,0xc7,0xea,0x9d,0xb0,
0x00,0x6c,0xd8,0xb4,0xab,0xc7,0x73,0x1f,
0x4d,0x21,0x95,0xf9,0xe6,0x8a,0x3e,0x52,
0x00,0x77,0xee,0x99,0xc7,0xb0,0x29,0x5e,
0x95,0xe2,0x7b,0x0c,0x52,0x25,0xbc,0xcb,
0x00,0x5a,0xb4,0xee,0x73,0x29,0xc7,0x9d,
0xe6,0xbc,0x52,0x08,0x95,0xcf,0x21,0x7b,
0x00,0x41,0x82,0xc3,0x1f,0x5e,0x9d,0xdc,
0x3e,0x7f,0xbc,0xfd,0x21,0x60,0xa3,0xe2,
0x00,0xd8,0xab,0x73,0x4d,0x95,0xe6,0x3e,
0x9a,0x42,0x31,0xe9,0xd7,0x0f,0x7c,0xa4,
0x00,0xc3,0x9d,0x5e,0x21,0xe2,0xbc,0x7f,
0x42,0x81,0xdf,0x1c,0x63,0xa0,0xfe,0x3d,
0x00,0xee,0xc7,0x29,0x95,0x7b,0x52,0xbc,
0x31,0xdf,0xf6,0x18,0xa4,0x4a,0x63,0x8d,
0x00,0xf5,0xf1,0x04,0xf9,0x0c,0x08,0xfd,
0xe9,0x1c,0x18,0xed,0x10,0xe5,0xe1,0x14,
0x00,0xb4,0x73,0xc7,0xe6,0x52,0x95,0x21,
0xd7,0x63,0xa4,0x10,0x31,0x85,0x42,0xf6,
0x00,0xaf,0x45,0xea,0x8a,0x25,0xcf,0x60,
0x0f,0xa0,0x4a,0xe5,0x85,0x2a,0xc0,0x6f,
0x00,0x82,0x1f,0x9d,0x3e,0xbc,0x21,0xa3,
0x7c,0xfe,0x63,0xe1,0x42,0xc0,0x5d,0xdf,
0x00,0x99,0x29,0xb0,0x52,0xcb,0x7b,0xe2,
0xa4,0x3d,0x8d,0x14,0xf6,0x6f,0xdf,0x46};

uint8_t taffine[256]={
0x63,0x7c,0x5d,0x42,0x1f,0x00,0x21,0x3e,
0x9b,0x84,0xa5,0xba,0xe7,0xf8,0xd9,0xc6,
0x92,0x8d,0xac,0xb3,0xee,0xf1,0xd0,0xcf,
0x6a,0x75,0x54,0x4b,0x16,0x09,0x28,0x37,
0x80,0x9f,0xbe,0xa1,0xfc,0xe3,0xc2,0xdd,
0x78,0x67,0x46,0x59,0x04,0x1b,0x3a,0x25,
0x71,0x6e,0x4f,0x50,0x0d,0x12,0x33,0x2c,
0x89,0x96,0xb7,0xa8,0xf5,0xea,0xcb,0xd4,
0xa4,0xbb,0x9a,0x85,0xd8,0xc7,0xe6,0xf9,
0x5c,0x43,0x62,0x7d,0x20,0x3f,0x1e,0x01,
0x55,0x4a,0x6b,0x74,0x29,0x36,0x17,0x08,
0xad,0xb2,0x93,0x8c,0xd1,0xce,0xef,0xf0,
0x47,0x58,0x79,0x66,0x3b,0x24,0x05,0x1a,
0xbf,0xa0,0x81,0x9e,0xc3,0xdc,0xfd,0xe2,
0xb6,0xa9,0x88,0x97,0xca,0xd5,0xf4,0xeb,
0x4e,0x51,0x70,0x6f,0x32,0x2d,0x0c,0x13,
0xec,0xf3,0xd2,0xcd,0x90,0x8f,0xae,0xb1,
0x14,0x0b,0x2a,0x35,0x68,0x77,0x56,0x49,
0x1d,0x02,0x23,0x3c,0x61,0x7e,0x5f,0x40,
0xe5,0xfa,0xdb,0xc4,0x99,0x86,0xa7,0xb8,
0x0f,0x10,0x31,0x2e,0x73,0x6c,0x4d,0x52,
0xf7,0xe8,0xc9,0xd6,0x8b,0x94,0xb5,0xaa,
0xfe,0xe1,0xc0,0xdf,0x82,0x9d,0xbc,0xa3,
0x06,0x19,0x38,0x27,0x7a,0x65,0x44,0x5b,
0x2b,0x34,0x15,0x0a,0x57,0x48,0x69,0x76,
0xd3,0xcc,0xed,0xf2,0xaf,0xb0,0x91,0x8e,
0xda,0xc5,0xe4,0xfb,0xa6,0xb9,0x98,0x87,
0x22,0x3d,0x1c,0x03,0x5e,0x41,0x60,0x7f,
0xc8,0xd7,0xf6,0xe9,0xb4,0xab,0x8a,0x95,
0x30,0x2f,0x0e,0x11,0x4c,0x53,0x72,0x6d,
0x39,0x26,0x07,0x18,0x45,0x5a,0x7b,0x64,
0xc1,0xde,0xff,0xe0,0xbd,0xa2,0x83,0x9c};

uint8_t sq[256]={
0x00,0x01,0x04,0x05,0x10,0x11,0x14,0x15,
0x40,0x41,0x44,0x45,0x50,0x51,0x54,0x55,
0x1b,0x1a,0x1f,0x1e,0x0b,0x0a,0x0f,0x0e,
0x5b,0x5a,0x5f,0x5e,0x4b,0x4a,0x4f,0x4e,
0x6c,0x6d,0x68,0x69,0x7c,0x7d,0x78,0x79,
0x2c,0x2d,0x28,0x29,0x3c,0x3d,0x38,0x39,
0x77,0x76,0x73,0x72,0x67,0x66,0x63,0x62,
0x37,0x36,0x33,0x32,0x27,0x26,0x23,0x22,
0xab,0xaa,0xaf,0xae,0xbb,0xba,0xbf,0xbe,
0xeb,0xea,0xef,0xee,0xfb,0xfa,0xff,0xfe,
0xb0,0xb1,0xb4,0xb5,0xa0,0xa1,0xa4,0xa5,
0xf0,0xf1,0xf4,0xf5,0xe0,0xe1,0xe4,0xe5,
0xc7,0xc6,0xc3,0xc2,0xd7,0xd6,0xd3,0xd2,
0x87,0x86,0x83,0x82,0x97,0x96,0x93,0x92,
0xdc,0xdd,0xd8,0xd9,0xcc,0xcd,0xc8,0xc9,
0x9c,0x9d,0x98,0x99,0x8c,0x8d,0x88,0x89,
0x9a,0x9b,0x9e,0x9f,0x8a,0x8b,0x8e,0x8f,
0xda,0xdb,0xde,0xdf,0xca,0xcb,0xce,0xcf,
0x81,0x80,0x85,0x84,0x91,0x90,0x95,0x94,
0xc1,0xc0,0xc5,0xc4,0xd1,0xd0,0xd5,0xd4,
0xf6,0xf7,0xf2,0xf3,0xe6,0xe7,0xe2,0xe3,
0xb6,0xb7,0xb2,0xb3,0xa6,0xa7,0xa2,0xa3,
0xed,0xec,0xe9,0xe8,0xfd,0xfc,0xf9,0xf8,
0xad,0xac,0xa9,0xa8,0xbd,0xbc,0xb9,0xb8,
0x31,0x30,0x35,0x34,0x21,0x20,0x25,0x24,
0x71,0x70,0x75,0x74,0x61,0x60,0x65,0x64,
0x2a,0x2b,0x2e,0x2f,0x3a,0x3b,0x3e,0x3f,
0x6a,0x6b,0x6e,0x6f,0x7a,0x7b,0x7e,0x7f,
0x5d,0x5c,0x59,0x58,0x4d,0x4c,0x49,0x48,
0x1d,0x1c,0x19,0x18,0x0d,0x0c,0x09,0x08,
0x46,0x47,0x42,0x43,0x56,0x57,0x52,0x53,
0x06,0x07,0x02,0x03,0x16,0x17,0x12,0x13};

uint8_t wshare[176] = {
    0x2b, 0x7e, 0x15, 0x16, 0x28, 0xae, 0xd2, 0xa6,
    0xab, 0xf7, 0x15, 0x88, 0x09, 0xcf, 0x4f, 0x3c,
    0xa0, 0xfa, 0xfe, 0x17, 0x88, 0x54, 0x2c, 0xb1,
    0x23, 0xa3, 0x39, 0x39, 0x2a, 0x6c, 0x76, 0x05,
    0xf2, 0xc2, 0x95, 0xf2, 0x7a, 0x96, 0xb9, 0x43,
    0x59, 0x35, 0x80, 0x7a, 0x73, 0x59, 0xf6, 0x7f,
    0x3d, 0x80, 0x47, 0x7d, 0x47, 0x16, 0xfe, 0x3e,
    0x1e, 0x23, 0x7e, 0x44, 0x6d, 0x7a, 0x88, 0x3b,
    0xef, 0x44, 0xa5, 0x41, 0xa8, 0x52, 0x5b, 0x7f,
    0xb6, 0x71, 0x25, 0x3b, 0xdb, 0x0b, 0xad, 0x00,
    0xd4, 0xd1, 0xc6, 0xf8, 0x7c, 0x83, 0x9d, 0x87,
    0xca, 0xf2, 0xb8, 0xbc, 0x11, 0xf9, 0x15, 0xbc,
    0x6d, 0x88, 0xa3, 0x7a, 0x11, 0x0b, 0x3e, 0xfd,
    0xdb, 0xf9, 0x86, 0x41, 0xca, 0x00, 0x93, 0xfd,
    0x4e, 0x54, 0xf7, 0x0e, 0x5f, 0x5f, 0xc9, 0xf3,
    0x84, 0xa6, 0x4f, 0xb2, 0x4e, 0xa6, 0xdc, 0x4f,
    0xea, 0xd2, 0x73, 0x21, 0xb5, 0x8d, 0xba, 0xd2,
    0x31, 0x2b, 0xf5, 0x60, 0x7f, 0x8d, 0x29, 0x2f,
    0xac, 0x77, 0x66, 0xf3, 0x19, 0xfa, 0xdc, 0x21,
    0x28, 0xd1, 0x29, 0x41, 0x57, 0x5c, 0x00, 0x6e,
    0xd0, 0x14, 0xf9, 0xa8, 0xc9, 0xee, 0x25, 0x89,
    0xe1, 0x3f, 0x0c, 0xc8, 0xb6, 0x63, 0x0c, 0xa6

};

/*
*   required for free and malloc
*/
extern int _end;

void *_sbrk(int incr) {
  static unsigned char *heap = NULL;
  unsigned char *prev_heap;

  if (heap == NULL) {
    heap = (unsigned char *)&_end;
  }
  prev_heap = heap;

  heap += incr;

  return prev_heap;
}


typedef struct
{
  int x,y;
  uint8_t *r;
  uint8_t *s;
  int flag;
  int m;
  int dmax;
} tprgmat;

typedef struct
{
  tprgmat *vabc;
  tprgmat *vi;
} tmprgmat;

tmprgmat mprgmat;

static unsigned long x=123456789, y=362436069, z=521288629;

unsigned long xorshf96(void) {   
  unsigned long t;

  x ^= x << 16;
  x ^= x >> 5;
  x ^= x << 1;

  t = x;
  x = y;
  y = z;
  z = t ^ x ^ y; 
  return z;
}

void refresh(uint8_t a[],int n)
{
  int i;
  for(i=1;i<n;i++)
  {
    uint8_t tmp=xorshf96(); //rand();
    a[0]=a[0] ^ tmp;
    a[i]=a[i] ^ tmp;
  }
}


void addroundkey_share(uint8_t stateshare[16],uint8_t wshare[176],int round)
{
  int i;
  for(i=0;i<16;i++)
    stateshare[i] ^= wshare[16*round+i];
}


void shiftrows_share(uint8_t share1[16], uint8_t share2[16])
{
  uint8_t m;
  int i;

  m=share1[1];
  share1[1]=share1[5];
  share1[5]=share1[9];
  share1[9]=share1[13];
  share1[13]=m;

  m=share1[2];
  share1[2]=share1[10];
  share1[10]=m;
  m=share1[6];
  share1[6]=share1[14];
  share1[14]=m;

  m=share1[3];
  share1[3]=share1[15];
  share1[15]=share1[11];
  share1[11]=share1[7];
  share1[7]=m;

  //-----------------------------

  m=share2[1];
  share2[1]=share2[5];
  share2[5]=share2[9];
  share2[9]=share2[13];
  share2[13]=m;

  m=share2[2];
  share2[2]=share2[10];
  share2[10]=m;
  m=share2[6];
  share2[6]=share2[14];
  share2[14]=m;

  m=share2[3];
  share2[3]=share2[15];
  share2[15]=share2[11];
  share2[11]=share2[7];
  share2[7]=m;

}

uint8_t get_prgmat(tprgmat *prgmat)
{
  uint8_t res;
  if(prgmat->flag==0)
    res=prgmat->r[prgmat->x] ^ prgmat->s[prgmat->y];
  else
    res=prgmat->r[prgmat->y] ^ prgmat->s[prgmat->x];

  if((prgmat->flag==0) && (prgmat->x!=prgmat->y))
  {
    prgmat->flag=1;
    return res;
  }

  prgmat->flag=0;
  
  prgmat->y++;
  if(prgmat->y>prgmat->m)
  {
    prgmat->y=0;
    prgmat->x++;
    prgmat->m++;
      
    prgmat->r[prgmat->m]=xorshf96();
    prgmat->s[prgmat->m]=xorshf96();
  }
  return res;
}

uint8_t get_mprgmatabc(int type,int i)
{
  return get_prgmat(&mprgmat.vabc[type*(1)+i]);
}

void locality_refresh_mprgmatabc(uint8_t *a1,uint8_t *a2,int type)
{
  for(int i=0;i<1;i++)
  {
    uint8_t r=get_mprgmatabc(type,i);
    *a2 ^=r ^ (*a1);
    *a1=r;
  }
}

void xor_loc(uint8_t *a,uint8_t *b1, uint8_t *b2,uint8_t *c)
{
  locality_refresh_mprgmatabc(&(a[0]), &(a[1]),PRGA);
  locality_refresh_mprgmatabc(b1, b2,PRGB);
  c[0] = a[0] ^ (*b1);
  c[1] = a[1] ^ (*b2);
  locality_refresh_mprgmatabc(&(c[0]),&(c[1]),PRGC);
}

uint8_t multx(uint8_t x)
{
  uint8_t y=x;
  y=y << 1;
  // if((x & 0x80)!=0)  y=y ^ 0x1b;
  uint8_t m[]={0,0x1b};
  y^=m[x >> 7];
  return y;
}

void xor_loc32(uint8_t *a1,uint8_t *a2,uint8_t *b1, uint8_t *b2,uint8_t *c)
{
  locality_refresh_mprgmatabc(a1,a2,PRGA);
  locality_refresh_mprgmatabc(b1,b2,PRGB);

  c[0] = multx(*a1) ^ (*a1) ^ multx(*b1);
  c[1] = multx(*a2) ^ (*a2) ^ multx(*b2);
  locality_refresh_mprgmatabc(&(c[0]),&(c[1]),PRGC);
}

void mixcolumns_share_loc(uint8_t share1[16],uint8_t share2[16])
{
  for(int j=0;j<4;j++)
  {
    uint8_t ns[4][2];
    
    xor_loc32(&(share1[j*4+1]), &(share2[j*4+1]),&(share1[j*4]), &(share2[j*4]),ns[0]);
    xor_loc(ns[0],&(share1[j*4+2]), &(share2[j*4+2]),ns[0]);
    xor_loc(ns[0],&(share1[j*4+3]), &(share2[j*4+3]),ns[0]);

    xor_loc32(&(share1[j*4+2]), &(share2[j*4+2]),&(share1[j*4+1]), &(share2[j*4+1]),ns[1]);
    xor_loc(ns[1],&(share1[j*4]), &(share2[j*4]),ns[1]);
    xor_loc(ns[1],&(share1[j*4+3]), &(share2[j*4+3]),ns[1]);

    xor_loc32(&(share1[j*4+3]), &(share2[j*4+3]),&(share1[j*4+2]), &(share2[j*4+2]),ns[2]);
    xor_loc(ns[2],&(share1[j*4]), &(share2[j*4]),ns[2]);
    xor_loc(ns[2],&(share1[j*4+1]), &(share2[j*4+1]),ns[2]);

    xor_loc32(&(share1[j*4]), &(share2[j*4]),&(share1[j*4+3]), &(share2[j*4+3]),ns[3]);
    xor_loc(ns[3],&(share1[j*4+1]), &(share2[j*4+1]),ns[3]);
    xor_loc(ns[3],&(share1[j*4+2]), &(share2[j*4+2]),ns[3]);

    for(int k=0;k<4;k++){
        share1[j*4+k] = ns[k][0];
        share2[j*4+k] = ns[k][1];
    }
  }
}

uint8_t square(uint8_t x)
{
  return sq[x];
}

void square_share(uint8_t *a)
{
  int i;
  for(i=0;i<2;i++)
    a[i]=square(a[i]);
}



void init_prgmat(tprgmat *prgmat,int dmax_)
{
  prgmat->dmax=dmax_;
  prgmat->m=0;
  prgmat->x=0;
  prgmat->y=0;
  prgmat->r=(uint8_t *) malloc(dmax_*sizeof(uint8_t));
  prgmat->s=(uint8_t *) malloc(dmax_*sizeof(uint8_t));
  prgmat->flag=0;
  prgmat->r[0]=xorshf96();
  prgmat->s[0]=xorshf96();
}

// Computes z=x*y in GF(2^8) using four 8-bit tables 
uint8_t multtable(uint8_t x,uint8_t y)
{
  return tsmult[0   | ((x & 15) << 4) | (y & 15)] ^
         tsmult[512 | (x & 240) | (y & 15)] ^
         tsmult[256 | ((x & 15) << 4) | (y >> 4)] ^
         tsmult[768 | (x & 240) | (y >> 4)];
}



void free_prgmat(tprgmat *prgmat)
{
  free(prgmat->r);
  free(prgmat->s);
}



void init_mprgmat()
{
  mprgmat.vabc=malloc(3*sizeof(tprgmat));
  for(int i=0;i<3;i++)
    init_prgmat(&mprgmat.vabc[i],1000);

  mprgmat.vi=malloc(1*sizeof(tprgmat));
  for(int i=0;i<1;i++)
    init_prgmat(&mprgmat.vi[i],1000);
  //printf("init_mprgmat\n");
}



uint8_t get_mprgmati(int i)
{
  return get_prgmat(&mprgmat.vi[i]);
}

void free_mprgmat()
{
  for(int i=0;i<3;i++)
    free_prgmat(&mprgmat.vabc[i]);
  
  for(int i=0;i<1;i++)
    free_prgmat(&mprgmat.vi[i]);

  free(mprgmat.vabc);
  free(mprgmat.vi);

}



void multshare_flr_mprgmat(uint8_t *a,uint8_t *b1, uint8_t *b2,uint8_t *c1,uint8_t *c2)
{

  locality_refresh_mprgmatabc(&(a[0]), &(a[1]),PRGA);
  locality_refresh_mprgmatabc(b1, b2,PRGB);

  *c1 = multtable(a[0],*b1);
  *c2 = multtable(a[1],*b2);

  int co=0;
  //for(int i=0;i<n;i++)
  //{
  //  for(int j=i+1;j<n;j++)
  //  {
  uint8_t tmp=get_mprgmati(co);
  
  co++;
  uint8_t tmp2=(tmp ^ multtable(a[0],*b2)) ^ multtable(a[1],*b1);
  
  (*c1)^=tmp;

  (*c2)^=tmp2;
  
  //  }
  //}
  locality_refresh_mprgmatabc(c1,c2,PRGC);
}

void subbyte_rp_share_func(uint8_t* s1, uint8_t* s2)
{
  // Memory: 5*n+5 uint8_t 
  int i;
  uint8_t z[2],z2[2];
  uint8_t one[2];

  for(i=1;i<2;i++)
    one[i]=0;

  one[0]=1;

  z[0] = *s1;
  z[1] = *s2;
  square_share(z);    // z=x^2     

  multshare_flr_mprgmat(z,&(one[0]),&(one[1]),&(z2[0]),&(z2[1]));  // z=Refresh(z)
  z[0] = z2[0];
  z[1] = z2[1];

  uint8_t y[2];
  multshare_flr_mprgmat(z,s1,s2,&(y[0]),&(y[1]));   // y=z*x=x^3

  uint8_t w[2];
  w[0] = y[0];
  w[1] = y[1];
  square_share(w);
  square_share(w);     // w=x^12

  uint8_t w2[2];
  multshare_flr_mprgmat(w,&(one[0]),&(one[1]),&(w2[0]),&(w2[1])); // w=Refresh(w)
  w[0] = w2[0];
  w[1] = w2[1];

  uint8_t y2[2];
  multshare_flr_mprgmat(y,&(w[0]),&(w[1]),&(y2[0]),&(y2[1]));   // y2=x^15

  square_share(y2);
  square_share(y2);
  square_share(y2);
  square_share(y2);    // y2=x^240
  
  multshare_flr_mprgmat(w,&(y2[0]),&(y2[1]),&(y[0]),&(y[1]));   // y=x^252
  multshare_flr_mprgmat(y,&(z[0]),&(z[1]),s1,s2);    // a=x^254

  //for(i=0;i<2;i++)
  //  a[i]=taffine[a[i]];
  *s1 = taffine[*s1];
  *s2 = taffine[*s2];
  
  *s1^=99;
}

__attribute__((noreturn, noinline)) void report_done()
{
    report_done();
}

void __attribute__((noinline)) initialize_local(uint8_t local[16], uint8_t uart[16]){
    for(int i = 0; i < 16; ++i){
        local[i] = uart[i];
    }
}

void cipher(uint8_t share1_local[16], uint8_t share2_local[16]){
    int i;

    init_mprgmat();
    
    int round=0;    

    addroundkey_share(share1_local,wshare,0);    
    
    for(round=1;round<10;round++)
    { 

      for(i=0;i<16;i++){
          subbyte_rp_share_func(&(share1_local[i]), &(share2_local[i]));  
      }

      shiftrows_share(share1_local, share2_local);
      mixcolumns_share_loc(share1_local, share2_local);
      addroundkey_share(share1_local,wshare,round);
    }
    

    for(i=0;i<16;i++){
        subbyte_rp_share_func(&(share1_local[i]), &(share2_local[i]));
    }
    shiftrows_share(share1_local, share2_local);
    addroundkey_share(share1_local,wshare,10);  

    free_mprgmat();  

}

int main(){

    uint8_t share1_local[16];
    uint8_t share2_local[16];
    
    initialize_local(share1_local, share1);
    initialize_local(share2_local, share2);

    cipher(share1_local, share2_local);

    initialize_local(share1, share1_local);
    initialize_local(share2, share2_local);

    report_done();

    
}